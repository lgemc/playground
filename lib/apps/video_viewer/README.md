# Video Viewer with Transcript Support

This app provides video playback with integrated transcript support, including segment-level timing, word-level timestamps, and speaker identification.

## Features

### Transcript Format (JSON)

Transcripts are stored as JSON files with the following structure:

```json
{
  "status": "success",
  "language": "en",
  "source_file": "video.mp4",
  "generated_at": "2024-01-01T12:00:00.000Z",
  "segments": [
    {
      "start": 0.378,
      "end": 12.849,
      "text": "In IELTS reading sometimes you have a picture...",
      "speaker": "SPEAKER_00",
      "words": [
        {
          "word": "In",
          "start": 0.378,
          "end": 0.438,
          "score": 0.926,
          "speaker": "SPEAKER_00"
        },
        ...
      ]
    },
    ...
  ]
}
```

### Transcript Model Classes

**`Transcript`** - Main transcript class
- `status`: Transcription status
- `language`: Language code (e.g., "en")
- `segments`: List of transcript segments
- `sourceFile`: Original video/audio file name
- `generatedAt`: Timestamp of generation
- Methods:
  - `fullText`: Get complete transcript as plain text
  - `duration`: Total duration in seconds
  - `segmentAt(timestamp)`: Find segment at specific time
  - `speakers`: Get all unique speakers

**`TranscriptSegment`** - Individual segment with timing
- `start`, `end`: Timestamps in seconds
- `text`: Segment text
- `words`: Word-level details
- `speaker`: Speaker identifier
- `startFormatted`, `endFormatted`: Human-readable timestamps

**`TranscriptWord`** - Word-level detail
- `word`: The word text
- `start`, `end`: Word timestamps
- `score`: Confidence score (0-1)
- `speaker`: Speaker identifier
- `confidencePercent`: Score as percentage

### Transcript Viewer Screen

Standalone viewer for transcript files with:
- **Segment list** with timestamps and speakers
- **Search** functionality to find text
- **Speaker filtering** to show only specific speakers
- **Word-level view** toggle to show individual word timings with confidence scores
- **Export** to multiple formats:
  - Plain text
  - JSON (original format)
  - WebVTT (.vtt) - for video subtitles
  - SRT (.srt) - for video subtitles
- **Click to seek** (when used with video player)

### Video Player with Transcript

The video player can display transcripts in a side panel:
- **Synchronized highlighting** - current segment highlighted as video plays
- **Click to seek** - tap any segment to jump to that timestamp
- **Toggle transcript** - show/hide button in app bar
- **Speaker labels** - each segment shows speaker ID
- **Auto-scroll** - follows playback position

### WhisperService API

**`transcribeDetailed(filePath)`**
- Returns full JSON response with segments and words
- Endpoint: `/transcribe`
- Fields: `file`, `language`

**`transcribe(filePath)`**
- Returns plain text (backward compatible)
- Concatenates all segment texts

### Usage Example

#### Generating Transcripts

Transcripts are automatically generated by `TranscriptGenerator` when:
1. User selects "Transcript" derivative for a video/audio file
2. File is processed through the derivative queue
3. Result is saved as JSON derivative artifact

#### Viewing Transcripts

**Option 1: Standalone viewer**
```dart
final transcript = Transcript.fromJsonString(jsonContent);
Navigator.push(
  context,
  MaterialPageRoute(
    builder: (context) => TranscriptViewerScreen(
      transcript: transcript,
      fileName: 'video.mp4',
    ),
  ),
);
```

**Option 2: With video player**
```dart
Navigator.push(
  context,
  MaterialPageRoute(
    builder: (context) => VideoPlayerScreen(
      filePath: '/path/to/video.mp4',
      fileName: 'video.mp4',
      transcript: transcript,  // Optional
    ),
  ),
);
```

#### Exporting Transcripts

The `TranscriptViewerScreen` includes built-in export to:
- **Plain text**: Simple text file
- **JSON**: Original structured format
- **WebVTT**: Standard subtitle format for web video
- **SRT**: Standard subtitle format for video players

#### Programmatic Export

```dart
// Get plain text
final text = transcript.fullText;

// Generate WebVTT
final vtt = StringBuffer('WEBVTT\n\n');
for (final segment in transcript.segments) {
  vtt.writeln('${formatVTT(segment.start)} --> ${formatVTT(segment.end)}');
  vtt.writeln(segment.text.trim());
  vtt.writeln();
}

// Generate SRT
int index = 1;
final srt = StringBuffer();
for (final segment in transcript.segments) {
  srt.writeln(index);
  srt.writeln('${formatSRT(segment.start)} --> ${formatSRT(segment.end)}');
  srt.writeln(segment.text.trim());
  srt.writeln();
  index++;
}
```

### Supported File Types

Audio and video files supported for transcription:
- **Video**: mp4, mpeg, mov, avi, webm, mkv, m4v, 3gp
- **Audio**: mp3, wav, ogg, flac, m4a, aac

### Configuration

WhisperService configuration (in ConfigService):
- `whisper.base_url`: API base URL (e.g., "http://192.168.0.7:8001")
- `whisper.language`: Language code (default: "en")
- `whisper.timeout_seconds`: Request timeout (default: "300")

### Architecture Notes

1. **JSON-first storage**: Transcripts stored as formatted JSON for maximum data preservation
2. **Type-safe models**: Strong typing with Dart classes for compile-time safety
3. **Lazy loading**: Transcripts loaded only when viewed
4. **Derivative system**: Integrates with existing file derivative workflow
5. **Export flexibility**: Can generate multiple formats from single JSON source
